# Vector Configuration for {{ inventory_hostname }}
# Generated by Ansible - DO NOT EDIT MANUALLY

data_dir = "{{ vector_data_dir }}"

# Source: systemd journal
[sources.journald]
type = "journald"
current_boot_only = false

{% if vector_log_paths | length > 0 %}
# Source: application log files
[sources.files]
type = "file"
include = {{ vector_log_paths | to_json }}
read_from = "beginning"
{% endif %}

# Transform: Add labels for Loki
[transforms.add_labels]
type = "remap"
inputs = {{ (["journald"] + (["files"] if vector_log_paths | length > 0 else [])) | to_json }}
source = '''
.hostname = "{{ inventory_hostname }}"
.service = "{{ inventory_hostname }}"
.environment = "{{ vector_environment }}"
{% if vector_log_paths | length > 0 %}
if exists(.file) {
  .log_type = "file"
} else {
  .log_type = "journal"
}
{% else %}
.log_type = "journal"
{% endif %}
'''

# Sink: Loki
[sinks.loki]
type = "loki"
inputs = ["add_labels"]
endpoint = "{{ vector_loki_endpoint }}"
encoding.codec = "json"

# Loki labels
labels.hostname = "{{ "{{ hostname }}" }}"
labels.service = "{{ "{{ service }}" }}"
labels.environment = "{{ "{{ environment }}" }}"
labels.log_type = "{{ "{{ log_type }}" }}"

# Batching configuration
[sinks.loki.batch]
max_bytes = 1048576  # 1MB
timeout_secs = 5

# Request configuration
[sinks.loki.request]
retry_attempts = 5
retry_max_duration_secs = 60
retry_initial_backoff_secs = 1
timeout_secs = 30

# Buffer configuration for reliability
[sinks.loki.buffer]
type = "disk"
max_size = 268435456  # 256MB
when_full = "block"
